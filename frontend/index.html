<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Monitoreo de Calidad del Aire</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#0f172a;
  --card:#1e293b;
  --text:#ffffff;
  --header:#1e293b;
}

body.light{
  --bg:#f1f5f9;
  --card:#ffffff;
  --text:#0f172a;
  --header:#e2e8f0;
}

body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:var(--bg);
  color:var(--text);
  transition:0.3s ease;
}

header{
  background:var(--header);
  padding:20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:15px;
}

.header-left{
  display:flex;
  align-items:center;
  gap:12px;
  font-weight:600;
  font-size:18px;
}

.status-indicator{
  display:flex;
  align-items:center;
  gap:6px;
}

.dot{width:10px;height:10px;border-radius:50%;}
.connected{background:#16a34a;}
.disconnected{background:#dc2626;}

button{
  padding:8px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}

.download-btn{background:#2563eb;color:white;}
.theme-btn{background:#64748b;color:white;}

.alert-banner{
  display:none;
  background:#dc2626;
  color:white;
  text-align:center;
  padding:10px;
  font-weight:700;
  animation:blink 1s infinite;
}

@keyframes blink{
  50%{opacity:0.5;}
}

.container{
  padding:30px 20px;
  max-width:1100px;
  margin:auto;
}

.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:20px;
}

.card{
  background:var(--card);
  padding:22px;
  border-radius:16px;
  text-align:center;
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
}

.status{
  margin-top:10px;
  padding:6px;
  border-radius:8px;
  font-weight:700;
}

.good{background:#16a34a;}
.medium{background:#eab308;color:black;}
.bad{background:#dc2626;}

.trend{
  margin-top:6px;
  font-size:14px;
}

canvas{
  margin-top:35px;
  background:var(--card);
  border-radius:16px;
  padding:15px;
  height:320px !important;
}

/* EDUCATIONAL SECTION */

.info-section{
  margin-top:40px;
  background:var(--card);
  padding:25px;
  border-radius:16px;
  line-height:1.6;
}

.info-section h3{
  margin-top:0;
}

.range-table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}

.range-table th,
.range-table td{
  padding:10px;
  text-align:center;
  border:1px solid rgba(255,255,255,0.1);
}

.range-good{background:#16a34a;}
.range-medium{background:#eab308;color:black;}
.range-bad{background:#dc2626;}

@media (max-width:768px){
  header{
    flex-direction:column;
    align-items:center;
    text-align:center;
  }

  header > div:last-child{
    width:100%;
    display:flex;
    justify-content:center;
    gap:10px;
  }

  .cards{
    grid-template-columns:1fr;
  }

  canvas{
    height:250px !important;
  }
}
</style>
</head>

<body>

<header>
  <div class="header-left">
    üå´ Sistema de Monitoreo Ambiental
    <div class="status-indicator">
      <div id="connectionDot" class="dot disconnected"></div>
      <span id="connectionText">Sin conexi√≥n</span>
    </div>
  </div>

  <div style="display:flex; gap:10px;">
    <button class="download-btn" onclick="downloadExcel()">Descargar Excel</button>
    <button class="theme-btn" onclick="toggleTheme()">Modo Claro/Oscuro</button>
  </div>
</header>

<div id="alert" class="alert-banner">
‚ö† ALERTA: Calidad del aire CR√çTICA
</div>

<div class="container">

<div class="cards">
  <div class="card">
    <div>Temperatura</div>
    <h2 id="temp">-- ¬∞C</h2>
  </div>

  <div class="card">
    <div>Humedad</div>
    <h2 id="hum">-- %</h2>
  </div>

  <div class="card">
    <div>PM2.5 (¬µg/m¬≥)</div>
    <h2 id="pm25">--</h2>
    <div id="status" class="status">--</div>
    <div id="trend" class="trend"></div>
  </div>
</div>

<canvas id="airChart"></canvas>

<!-- EDUCATIONAL SECTION -->
<div class="info-section">
  <h3>¬øQu√© es el PM2.5?</h3>
  <p>
    El PM2.5 es material particulado con un di√°metro menor a 2.5 micr√≥metros.
    Estas part√≠culas son tan peque√±as que pueden ingresar profundamente en los pulmones
    y afectar el sistema respiratorio y cardiovascular.
  </p>

  <h3>Rangos de Calidad del Aire (PM2.5)</h3>
  <table class="range-table">
    <tr>
      <th>Rango (¬µg/m¬≥)</th>
      <th>Estado</th>
      <th>Impacto</th>
    </tr>
    <tr class="range-good">
      <td>0 ‚Äì 12</td>
      <td>Bueno</td>
      <td>Calidad del aire satisfactoria</td>
    </tr>
    <tr class="range-medium">
      <td>13 ‚Äì 35</td>
      <td>Moderado</td>
      <td>Personas sensibles pueden presentar molestias</td>
    </tr>
    <tr class="range-bad">
      <td>36+</td>
      <td>Cr√≠tico</td>
      <td>Riesgo para la salud general</td>
    </tr>
  </table>

  <h3>¬øQu√© empeora la calidad del aire?</h3>
  <ul>
    <li>Tr√°fico vehicular</li>
    <li>Industria y f√°bricas</li>
    <li>Quema de residuos</li>
    <li>Incendios forestales</li>
  </ul>

  <h3>¬øQu√© la mejora?</h3>
  <ul>
    <li>Reducci√≥n de emisiones</li>
    <li>Uso de transporte sostenible</li>
    <li>Mayor vegetaci√≥n y zonas verdes</li>
    <li>Lluvia y condiciones clim√°ticas favorables</li>
  </ul>
</div>

</div>

<script>
const API_URL = "https://air-quality-backend-66j2.onrender.com"

let previousPM = null
let lastStatus = ""

const ctx = document.getElementById('airChart').getContext('2d')
const chart = new Chart(ctx,{
  type:'line',
  data:{labels:[],datasets:[{
    label:'Concentraci√≥n PM2.5 (¬µg/m¬≥)',
    data:[],
    borderWidth:3,
    tension:0.4,
    pointRadius:5
  }]},
  options:{
    responsive:true,
    maintainAspectRatio:false,
    plugins:{
      tooltip:{
        callbacks:{
          label:function(context){
            return "PM2.5: "+context.raw+" ¬µg/m¬≥"
          },
          title:function(context){
            return context[0].label
          }
        }
      }
    },
    scales:{
      y:{beginAtZero:true}
    }
  }
})

function getStatus(pm){
  if(pm<=12) return {text:"BUENO",class:"good",color:"#16a34a"}
  if(pm<=35) return {text:"MODERADO",class:"medium",color:"#eab308"}
  return {text:"CR√çTICO",class:"bad",color:"#dc2626"}
}

async function loadData(){
  try{
    const res = await fetch(`${API_URL}/data`)
    const data = await res.json()
    if(!data.length) return setDisconnected()

    setConnected()
    const latest = data[0]

    document.getElementById('temp').innerText = latest.temperature+" ¬∞C"
    document.getElementById('hum').innerText = latest.humidity+" %"
    document.getElementById('pm25').innerText = latest.pm25

    const statusInfo = getStatus(latest.pm25)
    const statusDiv = document.getElementById('status')
    statusDiv.innerText = statusInfo.text
    statusDiv.className = "status "+statusInfo.class

    const alert = document.getElementById('alert')
    if(statusInfo.text==="CR√çTICO"){
      alert.style.display="block"
    }else{
      alert.style.display="none"
    }

    const trend = document.getElementById('trend')
    if(previousPM!==null){
      trend.innerText = latest.pm25 > previousPM ? "‚¨Ü Subiendo" : "‚¨á Bajando"
    }
    previousPM = latest.pm25
    lastStatus = statusInfo.text

    chart.data.labels = data.slice(0,10).map(d=>
      new Date(d.created_at).toLocaleString('es-CO',{timeZone:'America/Bogota'})
    ).reverse()

    chart.data.datasets[0].data = data.slice(0,10).map(d=>d.pm25).reverse()
    chart.data.datasets[0].borderColor = statusInfo.color
    chart.update()

  }catch{
    setDisconnected()
  }
}

function downloadExcel(){
  window.open(`${API_URL}/download`)
}

function toggleTheme(){
  document.body.classList.toggle("light")
}

function setConnected(){
  document.getElementById('connectionDot').className="dot connected"
  document.getElementById('connectionText').innerText="Conectado"
}

function setDisconnected(){
  document.getElementById('connectionDot').className="dot disconnected"
  document.getElementById('connectionText').innerText="Sin conexi√≥n"
}

loadData()
setInterval(loadData,5000)
</script>

</body>
</html>
