<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<title>Sistema Inteligente de Calidad del Aire</title>

<style>
/* üîµ TODO TU CSS ORIGINAL EXACTAMENTE IGUAL */
:root{
--bg:#0b1220;
--card:#111827;
--card2:#0f172a;
--text:#f8fafc;
--muted:#94a3b8;
--border:rgba(255,255,255,0.05);
}
body.light{
--bg:#f1f5f9;
--card:#ffffff;
--card2:#f8fafc;
--text:#0f172a;
--muted:#475569;
--border:rgba(0,0,0,0.05);
background:#f1f5f9;
}
*{box-sizing:border-box}
body{
margin:0;
font-family:'Inter',sans-serif;
background:var(--bg);
color:var(--text);
overflow-x:hidden;
transition:.3s;
}
/* TODO LO DEM√ÅS DE TU CSS SIGUE EXACTAMENTE IGUAL */
</style>
</head>

<body>
<div class="wrapper">

<header class="fade">
<div class="brand">Sistema Inteligente de Calidad del Aire</div>
<div class="status">
<div id="dot" class="dot disconnected"></div>
<span id="statusText">Sin conexi√≥n</span>
<button onclick="toggleTheme()">Modo Claro/Oscuro</button>
<button onclick="downloadExcel()">Descargar Excel</button>
</div>
</header>

<section class="hero fade">
<h1>Monitoreo Inteligente</h1>
<p>Plataforma IoT para an√°lisis ambiental avanzado en tiempo real.</p>
<div class="clock" id="clock"></div>
</section>

<div class="main-card fade">
<div class="pm-value" id="pmValue">--</div>
<div class="pm-label" id="pmLabel"></div>
<div class="pm-info" id="pmInfo"></div>
<div class="bar">
<div class="marker" id="marker"></div>
</div>
<div class="range-labels">
<span class="range good">0 ‚Äì 12 Buena</span>
<span class="range moderate">12 ‚Äì 35 Moderada</span>
<span class="range bad">35+ Cr√≠tica</span>
</div>
</div>

<div class="metrics fade">
<div class="metric">
<h3>Temperatura</h3>
<h2 id="temp">--</h2>
</div>
<div class="metric">
<h3>Humedad</h3>
<h2 id="hum">--</h2>
</div>
</div>

<div class="analysis fade">
<h3>An√°lisis T√©cnico Ambiental</h3>
<div class="analysis-grid">
<div class="analysis-box">
<h4>Estado Actual</h4>
<p id="estadoBox"></p>
</div>
<div class="analysis-box">
<h4>Impacto en Salud</h4>
<p id="saludBox"></p>
</div>
<div class="analysis-box">
<h4>Tendencia Detectada</h4>
<p id="tendenciaBox"></p>
</div>
<div class="analysis-box">
<h4>Recomendaci√≥n T√©cnica</h4>
<p id="recomendacionBox"></p>
</div>
</div>
</div>

<div class="chart-card fade">
<canvas id="chart"></canvas>
</div>

<footer>
Plataforma desarrollada por <strong>Santiago Rubio</strong><br>
Proyecto de Ingenier√≠a Inform√°tica ‚Äì Sistema IoT de monitoreo ambiental
</footer>

</div>

<script>
const API_URL="https://air-quality-backend-66j2.onrender.com"

function toggleTheme(){
document.body.classList.toggle("light")
}

const observer=new IntersectionObserver(entries=>{
entries.forEach(entry=>{
if(entry.isIntersecting){entry.target.classList.add("show")}
})
})
document.querySelectorAll(".fade").forEach(el=>observer.observe(el))

function updateClock(){
document.getElementById("clock").innerText=new Date().toLocaleString()
}
setInterval(updateClock,1000)
updateClock()

function getStatus(pm){
if(pm<=12)return ["BUENA","#22c55e","La calidad del aire es √≥ptima."]
if(pm<=35)return ["MODERADA","#eab308","Puede afectar poblaci√≥n sensible."]
return ["CR√çTICA","#ef4444","Riesgo para la salud general."]
}

/* üî• NUEVA FUNCI√ìN CO */
function getCOStatus(co){
if(co<800)return ["NORMAL","#22c55e"]
if(co<1500)return ["MODERADO","#eab308"]
return ["PELIGROSO","#ef4444"]
}

function animateValue(id,start,end,duration){
let startTime=null
function step(timestamp){
if(!startTime)startTime=timestamp
let progress=Math.min((timestamp-startTime)/duration,1)
document.getElementById(id).innerText=Math.floor(progress*(end-start)+start)
if(progress<1)requestAnimationFrame(step)
}
requestAnimationFrame(step)
}

async function loadData(){
try{
const res=await fetch(`${API_URL}/data`)
const data=await res.json()
if(!data.length)return

document.getElementById("dot").className="dot connected"
document.getElementById("statusText").innerText="Conectado"

const latest=data[0]
const prev=data[1]

const [label,color,info]=getStatus(latest.pm25)

animateValue("pmValue",0,latest.pm25,800)
document.getElementById("pmValue").style.color=color
document.getElementById("pmLabel").innerText=label
document.getElementById("pmInfo").innerText=info
document.getElementById("temp").innerText=latest.temperature+" ¬∞C"
document.getElementById("hum").innerText=latest.humidity+" %"
document.getElementById("marker").style.left=Math.min((latest.pm25/60)*100,100)+"%"

/* üî• ALERTA CO */
if(latest.co!==undefined){
const [coLabel,coColor]=getCOStatus(latest.co)
document.getElementById("estadoBox").innerHTML=
`Concentraci√≥n actual de ${latest.pm25} ¬µg/m¬≥ clasificada como ${label}.<br>
CO: <strong style="color:${coColor}">${latest.co} ppm (${coLabel})</strong>`
}else{
document.getElementById("estadoBox").innerText=
`Concentraci√≥n actual de ${latest.pm25} ¬µg/m¬≥ clasificada como ${label}.`
}

document.getElementById("saludBox").innerText=
label==="BUENA"?"No representa riesgo.":
label==="MODERADA"?"Personas sensibles deben limitar exposici√≥n.":
"Se recomienda evitar actividades al aire libre."

document.getElementById("tendenciaBox").innerText=
prev && latest.pm25>prev.pm25?
"Tendencia ascendente detectada.":
"Tendencia estable o descendente."

document.getElementById("recomendacionBox").innerText=
label==="CR√çTICA"?
"Implementar medidas preventivas inmediatas.":
"Continuar monitoreo constante."

chart.data.labels=data.slice(0,20).map(d=>new Date(d.created_at).toLocaleTimeString()).reverse()
chart.data.datasets[0].data=data.slice(0,20).map(d=>d.pm25).reverse()
chart.update()

}catch{}
}

const ctx=document.getElementById("chart").getContext("2d")
const gradient=ctx.createLinearGradient(0,0,0,400)
gradient.addColorStop(0,"rgba(59,130,246,0.5)")
gradient.addColorStop(1,"rgba(59,130,246,0.05)")

const chart=new Chart(ctx,{
type:"line",
data:{labels:[],datasets:[{
data:[],
borderColor:"#3b82f6",
backgroundColor:gradient,
fill:true,
tension:.4,
pointRadius:3
}]},
options:{
responsive:true,
maintainAspectRatio:false,
plugins:{legend:{display:false}},
interaction:{mode:"index",intersect:false},
scales:{
x:{grid:{display:false}},
y:{grid:{color:"rgba(255,255,255,0.05)"}}
}
}
})

function downloadExcel(){
window.open(`${API_URL}/download`)
}

loadData()
setInterval(loadData,5000)
</script>

</body>
</html>
