<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<title>Sistema Inteligente de Calidad del Aire</title>
<style>
:root{
  --bg:#0b1220;
  --card:#111827;
  --card2:#0f172a;
  --text:#f8fafc;
  --muted:#94a3b8;
  --border:rgba(255,255,255,0.05);
}
body.light{
  --bg:#f1f5f9;
  --card:#ffffff;
  --card2:#f8fafc;
  --text:#0f172a;
  --muted:#475569;
  --border:rgba(0,0,0,0.05);
  background:#f1f5f9;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:var(--bg);
  color:var(--text);
  overflow-x:hidden;
  transition:.3s;
}
.wrapper{ max-width:1200px; margin:auto; padding:60px 20px; }
.fade{ opacity:0; transform:translateY(30px); transition:all .9s cubic-bezier(.16,1,.3,1); }
.fade.show{ opacity:1; transform:translateY(0); }

header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:70px; flex-wrap:wrap; gap:15px; }
.brand{ font-weight:700; font-size:20px; letter-spacing:-0.5px; }
.status{ display:flex; align-items:center; gap:10px; font-size:14px; }
.dot{ width:10px; height:10px; border-radius:50%; }
.connected{background:#22c55e}
.disconnected{background:#ef4444}
button{ background:#1f2937; color:white; border:1px solid var(--border); padding:8px 14px; border-radius:12px; cursor:pointer; transition:.3s; }
button:hover{ transform:translateY(-2px); background:#2563eb; }

.hero{ text-align:center; margin-bottom:70px; }
.hero h1{ font-size:44px; font-weight:800; letter-spacing:-1px; background:linear-gradient(90deg,#3b82f6,#22c55e); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.hero p{ color:var(--muted); max-width:650px; margin:20px auto; }
.clock{ font-size:14px; color:var(--muted); }

.main-card{ background:var(--card); padding:60px; border-radius:30px; text-align:center; box-shadow:0 30px 80px rgba(0,0,0,0.5); margin-bottom:70px; position:relative; overflow:hidden; }
.pm-value{ font-size:80px; font-weight:800; transition:.5s; }
.pm-label{ font-size:24px; margin-top:10px; }
.pm-info{ margin-top:10px; color:var(--muted); }

.bar{ margin:35px auto 0; max-width:600px; height:14px; border-radius:10px; background:linear-gradient(90deg,#22c55e,#eab308,#ef4444); position:relative; }
.marker{ width:18px; height:18px; background:white; border-radius:50%; position:absolute; top:-2px; transform:translateX(-50%); transition:.5s; }

.range-labels{ display:flex; justify-content:space-between; margin-top:12px; max-width:600px; margin-left:auto; margin-right:auto; font-size:13px; font-weight:500; }
.range{opacity:0.85;}
.range.good{color:#22c55e}
.range.moderate{color:#eab308}
.range.bad{color:#ef4444}

.metrics{ display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:30px; margin-bottom:70px; }
.metric{ position:relative; padding:45px; border-radius:28px; background:linear-gradient(145deg,var(--card2),var(--card)); border:1px solid var(--border); text-align:center; transition:.4s; overflow:hidden; backdrop-filter:blur(12px); }
.metric::after{ content:""; position:absolute; inset:0; border-radius:28px; padding:1px; background:linear-gradient(135deg,rgba(59,130,246,0.6),rgba(34,197,94,0.6)); -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite:xor; mask-composite:exclude; opacity:.35; }
.metric h3{ margin-bottom:12px; font-weight:600; color:var(--muted); }
.metric h2{ font-size:38px; font-weight:800; letter-spacing:-1px; }
.metric:hover{ transform:translateY(-8px); box-shadow:0 25px 50px rgba(0,0,0,0.4); }

.analysis{ background:var(--card); padding:45px; border-radius:30px; border:1px solid var(--border); margin-bottom:70px; }
.analysis h3{ margin-bottom:20px; text-align:center; }
.analysis-grid{ display:grid; grid-template-columns:1fr 1fr; gap:30px; }
.analysis-box{ background:var(--card2); padding:25px; border-radius:20px; border:1px solid var(--border); }
.analysis-box h4{ margin-bottom:10px; font-size:15px; color:#3b82f6; }
.analysis-box p{ font-size:14px; color:var(--muted); line-height:1.6; }

.chart-card{ background:var(--card); padding:40px; border-radius:30px; height:500px; border:1px solid var(--border); margin-bottom:80px; }

footer{ text-align:center; color:var(--muted); font-size:14px; padding-bottom:40px; border-top:1px solid var(--border); padding-top:30px; }

@media (max-width:768px){
  .wrapper{ padding:40px 16px; }
  header{ flex-direction:column; text-align:center; }
  .status{ justify-content:center; flex-wrap:wrap; }
  .hero h1{ font-size:30px; }
  .main-card{ padding:35px 20px; }
  .pm-value{ font-size:56px; }
  .range-labels{ flex-direction:column; gap:6px; align-items:center; text-align:center; }
  .metrics{ grid-template-columns:1fr; }
  .analysis{ padding:30px 20px; }
  .analysis-grid{ grid-template-columns:1fr; }
  .chart-card{ height:350px; padding:25px 15px; }
  button{ width:100%; max-width:260px; }
}
</style>
</head>
<body>
<div class="wrapper">

<header class="fade">
  <div class="brand">Sistema Inteligente de Calidad del Aire</div>
  <div class="status">
    <div id="dot" class="dot disconnected"></div>
    <span id="statusText">Sin conexión</span>
    <button onclick="toggleTheme()">Modo Claro/Oscuro</button>
    <button onclick="downloadExcel()">Descargar Excel</button>
  </div>
</header>

<section class="hero fade">
  <h1>Monitoreo Inteligente</h1>
  <p>Plataforma IoT para análisis ambiental avanzado en tiempo real.</p>
  <div class="clock" id="clock"></div>
</section>

<div class="main-card fade">
  <div class="pm-value" id="pmValue">--</div>
  <div class="pm-label" id="pmLabel"></div>
  <div class="pm-info" id="pmInfo"></div>
  <div class="bar">
    <div class="marker" id="marker"></div>
  </div>
  <div class="range-labels">
    <span class="range good">0 – 12 Buena</span>
    <span class="range moderate">12 – 35 Moderada</span>
    <span class="range bad">35+ Crítica</span>
  </div>
</div>

<div class="metrics fade">
  <div class="metric">
    <h3>Temperatura</h3>
    <h2 id="temp">--</h2>
  </div>

  <div class="metric">
    <h3>Humedad</h3>
    <h2 id="hum">--</h2>
  </div>

  <div class="metric">
    <h3>CO (Monóxido de Carbono)</h3>
    <h2 id="co">--</h2>

    <div class="bar" style="margin-top:20px; max-width:250px; height:10px;">
      <div class="marker" id="coMarker" style="width:14px;height:14px;top:-2px;"></div>
    </div>

    <div class="range-labels" style="max-width:250px;font-size:11px;">
      <span class="range good">0 – 9 Buena</span>
      <span class="range moderate">9 – 35 Moderada</span>
      <span class="range bad">35+ Crítica</span>
    </div>

  </div>
</div>

<div class="analysis fade">
  <h3>Análisis Técnico Ambiental</h3>
  <div class="analysis-grid">
    <div class="analysis-box">
      <h4>Estado Actual</h4>
      <p id="estadoBox"></p>
    </div>
    <div class="analysis-box">
      <h4>Impacto en Salud</h4>
      <p id="saludBox"></p>
    </div>
    <div class="analysis-box">
      <h4>Tendencia Detectada</h4>
      <p id="tendenciaBox"></p>
    </div>
    <div class="analysis-box">
      <h4>Recomendación Técnica</h4>
      <p id="recomendacionBox"></p>
    </div>
  </div>
</div>

<div class="chart-card fade">
  <canvas id="chart"></canvas>
</div>

<footer>
  Plataforma desarrollada por <strong>Santiago Rubio</strong><br>
  Proyecto de Ingeniería Informática – Sistema IoT de monitoreo ambiental
</footer>
</div>

<script>
const API_URL="https://air-quality-backend-66j2.onrender.com";

function toggleTheme(){ document.body.classList.toggle("light"); }

const observer=new IntersectionObserver(entries=>{
  entries.forEach(entry=>{
    if(entry.isIntersecting){entry.target.classList.add("show")}
  })
});
document.querySelectorAll(".fade").forEach(el=>observer.observe(el));

function updateClock(){ document.getElementById("clock").innerText=new Date().toLocaleString(); }
setInterval(updateClock,1000); updateClock();

function getStatus(pm){
  if(pm<=12) return ["BUENA","#22c55e","La calidad del aire es óptima."];
  if(pm<=35) return ["MODERADA","#eab308","Puede afectar población sensible."];
  return ["CRÍTICA","#ef4444","Riesgo para la salud general."];
}

function getCOStatus(co){
  if(co<=9) return ["BUENA","#22c55e"];
  if(co<=35) return ["MODERADA","#eab308"];
  return ["CRÍTICA","#ef4444"];
}

function animateValue(id,start,end,duration){
  let startTime=null;
  function step(timestamp){
    if(!startTime) startTime=timestamp;
    let progress=Math.min((timestamp-startTime)/duration,1);
    document.getElementById(id).innerText=Math.floor(progress*(end-start)+start);
    if(progress<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

async function loadData(){
  try{
    const res=await fetch(`${API_URL}/data`);
    const data=await res.json();
    if(!data.length) return;

    document.getElementById("dot").className="dot connected";
    document.getElementById("statusText").innerText="Conectado";

    const latest=data[0];
    const prev=data[1];

    const [label,color,info]=getStatus(latest.pm25);

    animateValue("pmValue",0,latest.pm25,800);
    document.getElementById("pmValue").style.color=color;
    document.getElementById("pmLabel").innerText=label;
    document.getElementById("pmInfo").innerText=info;

    document.getElementById("temp").innerText=latest.temperature+" °C";
    document.getElementById("hum").innerText=latest.humidity+" %";
    document.getElementById("co").innerText=latest.co+" ppm";

    const [coLabel,coColor]=getCOStatus(latest.co);
    document.getElementById("co").style.color=coColor;
    document.getElementById("coMarker").style.left=
      Math.min((latest.co/50)*100,100)+"%";

    document.getElementById("marker").style.left=
      Math.min((latest.pm25/60)*100,100)+"%";

    document.getElementById("estadoBox").innerText=
      `Concentración actual de ${latest.pm25} µg/m³ clasificada como ${label}.`;

    document.getElementById("saludBox").innerText=
      label==="BUENA"?"No representa riesgo.":
      label==="MODERADA"?"Personas sensibles deben limitar exposición.":
      "Se recomienda evitar actividades al aire libre.";

    document.getElementById("tendenciaBox").innerText=
      prev && latest.pm25>prev.pm25?
      "Tendencia ascendente detectada.":
      "Tendencia estable o descendente.";

    document.getElementById("recomendacionBox").innerText=
      label==="CRÍTICA"?
      "Implementar medidas preventivas inmediatas.":
      "Continuar monitoreo constante.";

    chart.data.labels = data.slice(0,20).map(d=>new Date(d.created_at).toLocaleTimeString()).reverse();
    chart.data.datasets[0].data = data.slice(0,20).map(d=>d.pm25).reverse();
    chart.update();

  }catch(err){
    console.error("Error cargando datos:",err);
  }
}

const ctx=document.getElementById("chart").getContext("2d");
const gradient=ctx.createLinearGradient(0,0,0,400);
gradient.addColorStop(0,"rgba(59,130,246,0.5)");
gradient.addColorStop(1,"rgba(59,130,246,0.05)");

const chart=new Chart(ctx,{
  type:"line",
  data:{
    labels:[],
    datasets:[{
      label:"PM2.5",
      data:[],
      borderColor:"#3b82f6",
      backgroundColor:gradient,
      fill:true,
      tension:.4,
      pointRadius:3
    }]
  },
  options:{
    responsive:true,
    maintainAspectRatio:false,
    plugins:{legend:{display:false}},
    interaction:{mode:"index",intersect:false},
    scales:{
      x:{grid:{display:false}},
      y:{grid:{color:"rgba(255,255,255,0.05)"}}
    }
  }
});

function downloadExcel(){ window.open(`${API_URL}/download`); }

loadData();
setInterval(loadData,5000);
</script>
</body>
</html>